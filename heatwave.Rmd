---
title: "Marine heatwaves with heatwaveR"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

Basic detection and visualization of events

```{r}
library(dplyr)
library(ggplot2)
library(heatwaveR)

## read data: the csv file is generated by GET_SATDATA.m
data = read.csv(file="sst_PATAG.csv") 
t = as.Date(data[ ,1])
temp = data[ , 2]
sst_PATAG = data.frame(t, temp)

# Detect the events in a time series
ts <- ts2clm(sst_PATAG, climatologyPeriod = c("2002-07-27", "2011-07-26"))
mhw <- detect_event(ts)

# View just a few metrics
mhw$event %>%
  dplyr::ungroup() %>%
  dplyr::select(event_no, duration, date_start, date_peak, intensity_max, intensity_cumulative) %>%
  dplyr::arrange(-intensity_max) %>%
  head(5)

event_line(mhw, spread = 180, metric = "intensity_max",
           start_date = "2002-07-27", end_date = "2019-12-31")

event_line(mhw, spread = 180, start_date = "2002-07-27", end_date = "2019-12-31", category = TRUE)

lolli_plot(mhw, metric = "intensity_max")

ggplot(mhw$event, aes(x = date_start, y = intensity_max)) +
  geom_lolli(colour = "salmon", colour_n = "red", n = 3) +
  geom_text(colour = "black", aes(x = as.Date("2003-01-01"), y = 5,
                label = "The marine heatwaves\nTend to be left skewed in a\nGiven time series")) +
  labs(y = expression(paste("Max. intensity [", degree, "C]")), x = NULL)
```

Calculating and Visualising Exceedances

```{r}
# Calculate exceedence
exc_val <- exceedance(sst_PATAG, threshold = 18)

# Look at a few metrics
exc_val$exceedance %>%
  ungroup() %>%
  select(exceedance_no, duration, date_start, date_peak, intensity_mean, intensity_max, intensity_cumulative) %>%
  dplyr::arrange(-intensity_cumulative) %>%
  head(5)

exc_val_thresh <- exc_val$threshold %>%
  slice(5300:7000)

ggplot(data = exc_val_thresh, aes(x = t)) +
  geom_flame(aes(y = temp, y2 = thresh, fill = "all"), show.legend = F) +
  geom_line(aes(y = temp, colour = "temp")) +
  geom_line(aes(y = thresh, colour = "thresh"), size = 1.0) +
  scale_colour_manual(name = "Line Colour",
                      values = c("temp" = "black", "thresh" =  "forestgreen")) +
  scale_fill_manual(name = "Event Colour", values = c("all" = "salmon")) +
  guides(colour = guide_legend(override.aes = list(fill = NA))) +
  scale_x_date(date_labels = "%b %Y") +
  labs(y = expression(paste("Temperature [", degree, "C]")), x = NULL)
```




